{{define "title"}}ShushTLS — Recipes{{end}}
{{define "content"}}
<h1>Recipes</h1>

<p>
  Two steps per platform: <strong>install the root CA</strong> (so the target trusts ShushTLS), then <strong>deploy the certificate</strong> (fetch cert and key, install for the platform&rsquo;s web UI or services). Issue the certificate first from <a href="/certificates">Certificates</a>, then follow the recipes for your platform.
</p>

{{if eq .State "uninitialized"}}
<article>
  <p><a href="/">Run Setup first</a> to generate the root CA and initialize ShushTLS.</p>
</article>
{{else}}

<p>
  <label for="recipe-cert-select"><strong>Certificate for scripts:</strong></label>
  <select id="recipe-cert-select" aria-label="Select certificate for recipe scripts">
    {{if not .Certs}}<option value="">— No certificates yet —</option>{{end}}
    {{range .Certs}}<option value="{{.PrimarySAN}}">{{.PrimarySAN}}</option>{{end}}
  </select>
</p>

<section id="synology">
<h2>Synology</h2>

<details>
  <summary><strong>1. Install root CA on Synology</strong></summary>
  <p>Add the ShushTLS root CA so the Synology trusts ShushTLS when fetching certs (avoids <code>-k</code> in scripts). Run once via SSH as root.</p>
  <pre><code># Save root to a persistent location (used by deploy script)
curl -kfsSL -o /root/shushtls-root.pem "{{.BaseURL}}/api/ca/root.pem"

# Add to system trust store (DSM 7.x). Creates hashed symlink for OpenSSL.
cp /root/shushtls-root.pem /etc/ssl/certs/shushtls-root.pem
ln -sf /etc/ssl/certs/shushtls-root.pem /etc/ssl/certs/$(openssl x509 -hash -noout -in /etc/ssl/certs/shushtls-root.pem).0</code></pre>
  <p>Alternatively, use <code>--cacert /root/shushtls-root.pem</code> in the deploy script curl commands instead of modifying the system store.</p>
</details>

<details>
  <summary><strong>2. Deploy certificate for DSM web UI</strong></summary>
  <p>Fetch certificate and key from ShushTLS and install on Synology DSM. The certificate SAN (e.g. <code>nas.example.com</code>) should match the hostname you use to access DSM.</p>

  <h3>Prerequisites</h3>
  <ul>
    <li>Certificate issued in ShushTLS for your Synology hostname (e.g. <code>nas.example.com</code>)</li>
    <li>Root CA installed (recipe 1 above) or use <code>-k</code> in curl</li>
    <li>SSH access to the Synology (or run on a machine that can reach both ShushTLS and the Synology)</li>
    <li>If auth is enabled: ShushTLS API credentials for key download</li>
  </ul>

  <h3>Scripted update (run on Synology or cron)</h3>
  <p>Save as <code>~/update-synology-cert.sh</code>, make executable (<code>chmod +x</code>), then run as root (or via Task Scheduler as root). Replace <code>BASE</code>, <code>SAN</code>, and optionally <code>AUTH</code>. Use <code>--cacert</code> if root is installed, or <code>-k</code> otherwise:</p>
  <pre><code id="synology-deploy-script">#!/bin/bash
BASE="{{.BaseURL}}"
SAN="__CERT_SAN__"
SAN_URL="__CERT_SAN_URL__"   # URL-encoded for API path (e.g. %2A.example.com)
AUTH=""   # e.g. AUTH="-u admin:yourpassword" if auth enabled
CACERT="--cacert /root/shushtls-root.pem"   # or CACERT="-k" to skip verification

set -e
TMP=$(mktemp -d)
trap "rm -rf $TMP" EXIT

# Fetch cert+key as tar (single request) — separate fetches generate new certs each time, so cert/key would mismatch
curl $CACERT -fsSL $AUTH -o "$TMP/bundle.tar" "$BASE/api/certificates/$SAN_URL?type=tar"
tar -x -C "$TMP" -f "$TMP/bundle.tar"
for f in "$TMP"/*.cert.pem; do [[ -f "$f" ]] && mv "$f" "$TMP/cert.pem" && break; done
for f in "$TMP"/*.key.pem; do [[ -f "$f" ]] && mv "$f" "$TMP/privkey.pem" && break; done
curl $CACERT -fsSL -o "$TMP/root.pem" "$BASE/api/ca/root.pem"
cat "$TMP/cert.pem" "$TMP/root.pem" &gt; "$TMP/fullchain.pem"

# Update default folder only — synow3tool will propagate to other locations
DEFAULT="/usr/syno/etc/certificate/system/default"
cp "$TMP/cert.pem" "$TMP/privkey.pem" "$TMP/fullchain.pem" "$DEFAULT/"
chown root:root "$DEFAULT"/{cert,privkey,fullchain}.pem
chmod 600 "$DEFAULT/privkey.pem"
chmod 644 "$DEFAULT"/{cert,fullchain}.pem

# chain.pem = intermediate/root only (some DSM configs expect it)
cp "$TMP/root.pem" "$DEFAULT/chain.pem"
# short-chain.pem = chain for single-tier CA (DSM may expect this)
cp "$TMP/root.pem" "$DEFAULT/short-chain.pem"
chown root:root "$DEFAULT"/{chain,short-chain}.pem
chmod 644 "$DEFAULT"/{chain,short-chain}.pem

# synow3tool propagates certs and regenerates nginx config. Restart nginx.
if ! /usr/syno/bin/synow3tool --gen-all 2>/dev/null || ! /usr/syno/bin/synosystemctl restart nginx 2>/dev/null; then
  echo "Warning: synow3tool or nginx restart failed. Check /var/log/nginx.error and /usr/syno/etc/certificate/ for details."
fi
echo "Done. Certificate updated."</code></pre>
  <p>Schedule in <strong>Control Panel → Task Scheduler</strong>: create a scheduled task (e.g. weekly), run as <code>root</code>, user-defined script pointing to this file.</p>

  <h3>Manual import</h3>
  <p>For one-time setup: download the <a href="/certificates">cert+key bundle</a> (tar or zip) from ShushTLS, extract it, then <strong>Control Panel → Security → Certificate → Add → Import Certificate</strong>. Upload the certificate and private key. Choose &ldquo;Use as default certificate&rdquo; if replacing the DSM certificate. Manual import must be repeated when the cert is renewed.</p>

  <h3>Troubleshooting</h3>
  <p>If you see &ldquo;Generated nginx tmp config is not valid&rdquo;: try <strong>manual import first</strong> to establish the cert structure, then use the script for subsequent updates. The script adds <code>chain.pem</code> and <code>short-chain.pem</code> (some DSM versions expect these). Check <code>/var/log/nginx.error</code> and <code>/usr/syno/etc/certificate/</code> for details.</p>

  <h3>Recovery (restore DSM after a broken cert)</h3>
  <p>If DSM is broken after running the script (web UI inaccessible, nginx errors): SSH in as root and try:</p>
  <ol>
    <li><strong>Restore from another cert location</strong> — Other DSM services (smbftpd, LogCenter, etc.) usually keep a copy of the original Synology cert. Copy it back to default:
      <pre><code>DEFAULT="/usr/syno/etc/certificate/system/default"
SRC="/usr/syno/etc/certificate/smbftpd/ftpd"   # or /usr/syno/etc/certificate/kmip/kmip
for f in cert privkey fullchain chain short-chain; do
  [[ -f "$SRC/$f.pem" ]] && cp "$SRC/$f.pem" "$DEFAULT/"
done
# If no chain/short-chain, create from syno-ca-cert
[[ -f "$SRC/syno-ca-cert.pem" ]] && cp "$SRC/syno-ca-cert.pem" "$DEFAULT/chain.pem"
[[ -f "$SRC/syno-ca-cert.pem" ]] && cp "$SRC/syno-ca-cert.pem" "$DEFAULT/short-chain.pem"
chown root:root "$DEFAULT"/*.pem
chmod 600 "$DEFAULT/privkey.pem"
chmod 644 "$DEFAULT"/{cert,fullchain,chain,short-chain}.pem
/usr/syno/bin/synow3tool --gen-all
/usr/syno/bin/synosystemctl restart nginx</code></pre>
    </li>
    <li><strong>If that fails</strong> — Generate a new self-signed cert and import via DSM UI: <code>Control Panel → Security → Certificate → Add → Import</code>. Or create one via SSH:
      <pre><code>openssl req -x509 -newkey rsa:4096 -keyout /tmp/recovery.key -out /tmp/recovery.crt -sha256 -days 3650 -nodes -subj "/CN=nas" -addext "subjectAltName=DNS:nas,DNS:nas.local,IP:127.0.0.1"
# Then import via DSM (Add → Import) if you can reach it over HTTP, or copy to default and run synow3tool</code></pre>
    </li>
    <li><strong>Last resort</strong> — DSM reinstall may be needed if the cert structure is badly corrupted.</li>
  </ol>
</details>
</section>

<section id="traefik">
<h2>Traefik</h2>
<details>
  <summary><strong>1. Install root CA</strong></summary>
  <p><em>Recipe content to be added.</em></p>
</details>
<details>
  <summary><strong>2. Deploy certificate</strong></summary>
  <p><em>Recipe content to be added.</em></p>
</details>
</section>

<section id="unifi">
<h2>Unifi</h2>
<details>
  <summary><strong>1. Install root CA</strong></summary>
  <p><em>Recipe content to be added.</em></p>
</details>
<details>
  <summary><strong>2. Deploy certificate</strong></summary>
  <p><em>Recipe content to be added.</em></p>
</details>
</section>

{{end}}
{{end}}
